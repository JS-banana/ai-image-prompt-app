# AI Image App（BYOK 多人使用版）架构与体验优化路线图

日期：2025-12-14

> 本文基于 `docs/2025-12-13-gemini-review-report.md` 的审计建议，并结合当前项目真实约束（Next.js 16 + Prisma/SQLite，部署到 Vercel，多人访问、用户自带 API Key）整理成可执行的工程方案与任务顺序。

---

## 1. 已确认的产品决策（你已选择）

1. **不做永久保存**：生成结果默认仅保留在浏览器侧（有限条数），提供下载/导出作为“成本回收”手段。
2. **多人使用（B）**：面向朋友/团队成员开放使用。
3. **UI 组件体系（A）**：采用 Shadcn/Radix（Headless + 可访问性完备 + Popover/Command/Dialog/Toast/Skeleton）。

---

## 2. 目标与非目标

### 2.1 目标（Goals）

- **第一次打开 10 秒内能生成**：用户在 `/generate` 粘贴自己的 Ark API Key 后即可生成，无需改 `.env` 或部署配置。
- **交互可靠**：弹层不溢出屏幕、支持 Esc/点击外部关闭、焦点管理/键盘操作基本可用。
- **可维护**：核心生成页不再是上帝组件；业务逻辑（模型判断、分辨率校验、请求与错误处理）集中到 hook/service。
- **历史“够用”**：默认保留最近 N 条 + 一键下载/导出（不做长期云端存图）。

### 2.2 非目标（Non-goals）

- 不在当前迭代做“深色赛博风默认主题”整体换肤（可后续单独做视觉迭代）。
- 不在当前迭代引入账号体系/多租户权限模型（但会预留最小的“写入保护”能力）。
- 不在当前迭代做“永久保存/对象存储/云端图库”。

---

## 3. 当前关键风险（结合真实线上问题）

1. **工程稳定性优先级高于 UI 美化**  
   近期 Vercel 构建失败来自 pnpm 忽略依赖 build scripts（Prisma Client 未 generate），属于“不是业务 bug 但会阻断交付”的问题。后续任何重构必须确保：`lint + typecheck + build` 可稳定通过。

2. **生成页耦合过高会阻断迭代**  
   `src/app/generate/client.tsx` 已经 >1000 行，状态/副作用/本地存储/弹层 UI 混在一起，继续加功能（导出、更多模型、更多编辑能力）会非常痛苦。

3. **多人 BYOK 的权限边界要明确**  
   没有账号体系时，“谁能改 prompts/models 数据库”必须明确，否则多人使用会有误改风险。

---

## 4. 总体方案（按优先级排序）

### Stage 1：先拆分生成页（不引入新 UI 库）

**目的**：先把 `GenerateClient` 从“上帝组件”拆成可演进结构；保持现有样式不变，降低风险。

交付：

- `useImageGeneration()`：封装请求、loading、错误映射、成功写入历史/滚动到预览。
- `useSeedreamHistory()`：封装 localStorage 读取/写入与条数上限。
- `useApiKeyStatus()`：封装 `/api/apikey` 的状态拉取、保存、清除。
- UI 拆组件：Prompt 区 / 结果预览 / 历史列表 / 弹窗等，降低单文件复杂度。

验收：

- `pnpm lint` / `pnpm typecheck` / `pnpm build` 通过。
- 生成流程与现有功能保持一致（回归：上传图生图、历史回填、下载、查看大图、Key 面板）。

---

### Stage 2：引入 Shadcn/Radix（替换脆弱弹层 + 统一反馈）

**目的**：解决 Popover/弹层/可搜索下拉/Toast/加载反馈的“可靠性与可访问性”问题。

优先替换点：

- Prompt 选择：Popover + Command（支持搜索）
- 模型/分辨率选择：Popover/Select
- API Key 配置：Dialog（可聚焦、可键盘操作、可点击外部关闭）
- 反馈：Toast（成功/失败）+ Skeleton（生成中预览占位）

验收：

- 移动端不溢出、键盘交互可用（Esc/Tab/Enter 基本正常）
- 错误不再散落在 UI 各处，统一由 toast/alert 呈现
- `pnpm lint` / `pnpm typecheck` / `pnpm build` 通过

---

### Stage 3：不永久保存前提下的“历史增强”（导出/提示/批量）

**目的**：在不做云端永久保存的前提下，把“成本不想浪费”的诉求落到体验里。

交付（建议优先级从高到低）：

1. 导出 JSON（仅元数据 + URL）：便于迁移/留档
2. 清空历史/设置条数上限（默认 12，可配置）
3. 明确提示：第三方 URL 可能过期，建议下载到本地
4. （可选）一键下载最近 N 张（逐个触发下载，注意浏览器限制）

验收：

- 导出文件结构稳定，可再次导入/查看（导入可后续做）
- 生成页核心流程不受影响

---

### Stage 4（可选）：多人场景下的写入保护

**目的**：避免 prompts/models 数据被误改，同时不破坏“生成页 BYOK 一键使用”体验。

推荐策略（两种选一）：

- A：整站访问口令（更安全，但增加一步）
- B：仅“写操作”需要管理员口令（推荐）：生成与浏览不受影响，编辑/新增需要授权

> Stage 4 是否执行取决于你是否希望成员“能改提示词库/模型配置”。如果成员只需要使用/复制提示词，则应默认只读。

---

## 5. 测试与回归清单（每个 Stage 完成后执行）

基础质量：

- `pnpm lint`
- `pnpm typecheck`
- `pnpm build`

关键路径回归（/generate）：

- 未配置 Key：点击生成 → 自动提示并打开 Key 配置
- 配置 Key：保存后生成成功
- 上传图片：能走图生图
- 下载按钮可用
- 历史回填可用（编辑回填）
- 查看大图弹窗可用

---

## 6. 风险与应对

- **Vercel 构建依赖脚本被忽略**：通过 pnpm `onlyBuiltDependencies` + `postinstall prisma generate` 固化。
- **SQLite 在 Serverless 环境不可写**：默认只读数据（prompts/models）可继续使用；若必须写入（后续 Stage 4/更多功能），应迁移到 Turso/libsql 或 Postgres。
- **多人 BYOK 的安全边界**：明确“Key 只存于浏览器 Cookie（httpOnly）”，不入库；如需要跨设备同步再引入账号体系。
